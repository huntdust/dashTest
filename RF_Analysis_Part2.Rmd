---
title: "RF_Analysis_Part2"
author: "Andrew Yokubaitis"
output: html_document
---

```{r setup, include=FALSE}
# Clear R session
rm(list=ls())

# Prevents java OOM errors when trying to create the excel files
knitr::opts_chunk$set(echo = TRUE, fig.height = 7, fig.width = 10)
options(java.parameters = "-Xmx10g")

#library(openxlsx)
#library(xlsx)
library(readxl)
library(dplyr)
library(data.table)
library(gtools) # enables the mixed sort function
library(ggplot2)
library(reshape2)
library(plotly)
library(readbulk)
library(stringr)
library(tictoc)
#options(digits = 14)
options(dplyr.summarise.inform = FALSE)



##########################
# User defined variables #


# Path to where the data is stored
  # Note: Windows uses "\" in its file names by default and they must be chagned to "/" in the script to function properly
#pth <- "//pilly/jaguar/interface/project/MX-44/Agoura Hills Data Analysis and Pics/Data and Analysis/Gore/Gore_PA_Bit63/Data/All_Data_Every_10th"
#pth <- "C:/R_Programs/Nutcracker_Data/Falcon_Pair_1/Test1"
#pth <- "E:/Teradyne_WFH/Falcon_Cross-Corr_Data/All_Data/Test1"
#pth <- "//pilly/jaguar/interface/project/MX44e/Pilot Line Issues/s2p"

#pth <- "C:/Gryffindor/Data/KeyenceIntegrationTest_reduced/"
pth <- "//pilly/jaguar/interface/project/Gryffindor/Data_and_Results/Gore_Cable3_Rot_Cyl_Centering_Blocks/"

company <- "Gore"

cable_name <- "Reduced Data For Testing Temp Plots"

# Total number of cycles the cable experienced during the collection of this data set
total_cycles <- 250
#total_cycles <- df$Cycle[length(df$Cycle)]

# Sets the Number of cycles between measurements; allows use of less data to lower computation time
cycs_between_meas <- 5


# declare how many cables are included in this data set so that the max phase shift between cables can be correctly calculated
num_cables <- 1

# Specify if this data is from a Falcon test and should therefore have the adpater losses subtracted from the results
is_falcon <- FALSE


# Freq to check insertion loss and return loss at to see how it varies over time
desired_freq_high <- 53
desired_freq_low  <- 10


# Specify if which S11 and S21 specs should be used in the plots
  # values can be low, mid, high, or mx44
s11_spec <- "Falcon"
s21_spec <- "Falcon"

# End of User Defined Variables #
#################################

# Get the path to the aggregated data files
normal_pth <- paste(pth, "Aggregated_Data.csv", sep = "")
smry_pth <- paste(pth, "Summary_Data.csv", sep = "")

# Read in the data
df <- read.csv(normal_pth)
smry <- read.csv(smry_pth)

# Change the type of the filetimes to POSIXct (time series)
df$filetimes <- as.POSIXct(df$filetimes)

# Get the closest frequencies to the desired freq high and low in the data set
closest_freq_low <- df$Freq_GHz[which(abs(df$Freq_GHz - desired_freq_low) == min(abs(df$Freq_GHz - desired_freq_low)))][1]
closest_freq_high <- df$Freq_GHz[which(abs(df$Freq_GHz - desired_freq_high) == min(abs(df$Freq_GHz - desired_freq_high)))][1]

# Load the temperature data

#temperature_path <- "C:/Gryffindor/temperature_data/tempData_gryffindor - Copy.txt"
temperature_path <- "//pilly/Advanced_Signal_Delivery/Personal_Folders/Dustin/tempData_gryffindor.txt"
temperature_df <- read.csv(temperature_path, sep = "\t")

# Change the time to POSIXct

temperature_df$Time <- as.POSIXct(temperature_df$Time, format = "%m/%d/%Y %H:%M:%S")
names(temperature_df) <- c("Time", "Temperature", "Humidity")

```


#### Plot 1.1.1: All S21 Data

This plot is used to visualize the S21 data taken over the course of the `r total_cycles` mating cycles on the `r company` `r cable_name`. The color of each trace corresponds to which mating cycle the data sample was taken on with red indicating earlier measurements and purple indicating later measurements.

```{r Plotting1.1.1, echo = FALSE, warning = FALSE}
# Load the Gore predicted loss data
# gore <- read_xlsx(path = "E:/Teradyne_WFH/Gore_Insertion_Loss_Curves.xlsx", sheet = 4)
# names(gore) <- c("Frequency", "Gauranteed Worst Loss")
# gore <- gore[which(gore$Frequency < 67),]



# Load the data
df_melt_S21 <- melt(df, id.vars = c("Freq_GHz","Cycle","S21_spec_low","S21_spec_mid","S21_spec_high", "S21_spec_falcon"), measure.vars = c("S21_dB"))
names(df_melt_S21) <- c("Frequency", "Cycle", "S21_spec_low","S21_spec_mid","S21_spec_high", "S21_spec_falcon", "variable", "Loss")

# Create the highlight key
h <- highlight_key(df_melt_S21, ~Cycle)


# Create the plot    
title <- "Insertion Loss vs Frequency"
p <- ggplot(data = h, mapping = aes(x = Frequency)) +
  geom_line(size = 0.5, aes(y = Loss, color = Cycle)) +
  labs(x = "Frequency (GHz)", y = "Magnitude of S21 (dB)", col = "Cycle") +
  ggtitle(title) +
  scale_color_gradientn(colors = rainbow(6)) +
  theme_minimal() + # this theme makes the plot very similar to the default plotly aesthetic
  theme(plot.title = element_text(hjust = 0.5))




# Add specs to the plot if desired
if(s21_spec == "low"){
  spec_table <- data.table(df_melt_S21$Frequency[which(df_melt_S21$Cycle == df_melt_S21$Cycle[1])], df_melt_S21$S21_spec_low[which(df_melt_S21$Cycle == df_melt_S21$Cycle[1])])
  names(spec_table) <- c("Frequency", "Spec")
  p <- p + geom_line(data = spec_table, aes(y = Spec), color = "red")
} else if (s21_spec == "mid"){
  spec_table <- data.table(df_melt_S21$Frequency[which(df_melt_S21$Cycle == df_melt_S21$Cycle[1])], df_melt_S21$S21_spec_mid[which(df_melt_S21$Cycle == df_melt_S21$Cycle[1])])
  names(spec_table) <- c("Frequency", "Spec")
  p <- p + geom_line(data = spec_table, aes(y = Spec), color = "red")
} else if (s21_spec == "high"){
  spec_table <- data.table(df_melt_S21$Frequency[which(df_melt_S21$Cycle == df_melt_S21$Cycle[1])], df_melt_S21$S21_spec_high[which(df_melt_S21$Cycle == df_melt_S21$Cycle[1])])
  names(spec_table) <- c("Frequency", "Spec")
  p <- p + geom_line(data = spec_table, aes(y = Spec), color = "red")
} else if (s21_spec == "Falcon"){
  spec_table <- data.table(df_melt_S21$Frequency[which(df_melt_S21$Cycle == df_melt_S21$Cycle[1])], df_melt_S21$S21_spec_falcon[which(df_melt_S21$Cycle == df_melt_S21$Cycle[1])])
  names(spec_table) <- c("Frequency", "Spec")
  p <- p + geom_line(data = spec_table, aes(y = Spec), color = "red")
}


# Add the line for the worst case gore losses
# p <- p + geom_line(data = gore, aes(y = `Gauranteed Worst Loss`), color = "black")



# Generate the plot
p21 <- ggplotly(p, dynamicTicks = TRUE, tooltip = c("Frequency", "Loss", "Cycle", "Spec")) %>% layout(xaxis = list(autorange = FALSE))


# Select which plot manipulation buttons are displayed in the top right
p21 <- config(p21, modeBarButtonsToRemove = c("zoomIn2d", "zoomOut2d", "lasso2d", "select2d", "toggleSpikelines","autoScale2d"))

# Enable highliting when a trace is clicked and change the selected trace to black
p21 <- highlight(p21, on = "plotly_click", off = "plotly_doubleclick", color = "black")
p21

```
<center> TERADYNE CONFIDENTIAL DO NOT DISTRIBUTE </center>  


#### Plot 1.1.2: All S21 Data Animation

This plot is the same as the previous plot, but allows for the user to animate the traces to see how they evolve over time, or to look at any individual trace on its own.


```{r Plotting1.1.2, echo = FALSE, warning = FALSE}
# Load the data
# Load the Gore predicted loss data
# gore <- read_xlsx(path = "E:/Teradyne_WFH/Gore_Insertion_Loss_Curves.xlsx", sheet = 4)
# names(gore) <- c("Frequency", "Gauranteed Worst Loss")
# gore <- gore[which(gore$Frequency < 67),]



# Load the data
df_melt_S21 <- melt(df, id.vars = c("Freq_GHz","Cycle","S21_spec_low","S21_spec_mid","S21_spec_high", "S21_spec_falcon"), measure.vars = c("S21_dB"))
names(df_melt_S21) <- c("Frequency", "Cycle", "S21_spec_low","S21_spec_mid","S21_spec_high", "S21_spec_falcon", "variable", "Loss")

# Create the highlight key
h <- highlight_key(df_melt_S21, ~Cycle)


# Create the plot    
title <- "Insertion Loss vs Frequency"
p <- ggplot(data = h, mapping = aes(x = Frequency)) +
  geom_line(size = 0.5, aes(y = Loss, frame = Cycle)) +
  labs(x = "Frequency (GHz)", y = "Magnitude of S21 (dB)", col = "Cycle") +
  ggtitle(title) +
  scale_color_gradientn(colors = rainbow(6)) +
  theme_minimal() + # this theme makes the plot very similar to the default plotly aesthetic
  theme(plot.title = element_text(hjust = 0.5))




# Add specs to the plot if desired
if(s21_spec == "low"){
  spec_table <- data.table(df_melt_S21$Frequency[which(df_melt_S21$Cycle == df_melt_S21$Cycle[1])], df_melt_S21$S21_spec_low[which(df_melt_S21$Cycle == df_melt_S21$Cycle[1])])
  names(spec_table) <- c("Frequency", "Spec")
  p <- p + geom_line(data = spec_table, aes(y = Spec), color = "red")
} else if (s21_spec == "mid"){
  spec_table <- data.table(df_melt_S21$Frequency[which(df_melt_S21$Cycle == df_melt_S21$Cycle[1])], df_melt_S21$S21_spec_mid[which(df_melt_S21$Cycle == df_melt_S21$Cycle[1])])
  names(spec_table) <- c("Frequency", "Spec")
  p <- p + geom_line(data = spec_table, aes(y = Spec), color = "red")
} else if (s21_spec == "high"){
  spec_table <- data.table(df_melt_S21$Frequency[which(df_melt_S21$Cycle == df_melt_S21$Cycle[1])], df_melt_S21$S21_spec_high[which(df_melt_S21$Cycle == df_melt_S21$Cycle[1])])
  names(spec_table) <- c("Frequency", "Spec")
  p <- p + geom_line(data = spec_table, aes(y = Spec), color = "red")
} else if (s21_spec == "Falcon"){
  spec_table <- data.table(df_melt_S21$Frequency[which(df_melt_S21$Cycle == df_melt_S21$Cycle[1])], df_melt_S21$S21_spec_falcon[which(df_melt_S21$Cycle == df_melt_S21$Cycle[1])])
  names(spec_table) <- c("Frequency", "Spec")
  p <- p + geom_line(data = spec_table, aes(y = Spec), color = "red")
}


# Add the line for the worst case gore losses
# p <- p + geom_line(data = gore, aes(y = `Gauranteed Worst Loss`), color = "black")



# Generate the plot
p21 <- ggplotly(p, dynamicTicks = TRUE, tooltip = c("Frequency", "Loss", "Cycle", "Spec")) %>% layout(xaxis = list(autorange = FALSE))


# Select which plot manipulation buttons are displayed in the top right
p21 <- config(p21, modeBarButtonsToRemove = c("zoomIn2d", "zoomOut2d", "lasso2d", "select2d", "toggleSpikelines","autoScale2d"))

# Enable highliting when a trace is clicked and change the selected trace to black
p21 <- highlight(p21, on = "plotly_click", off = "plotly_doubleclick", color = "black")
p21
```


#### Plot 1.2: Mean - 6 Sigma

This plot is used to calculate and visualize the mean + 6 sigma of S21 at each frequency over the `r total_cycles` cycles preformed on the `r company` `r cable_name`:

```{r Plotting1.2, echo = FALSE, warning = FALSE}
# Standard deviation of S21 across frequencies
coverage_factor <- 6

# Create the title
title <- "Insertion Loss Mean - 6 Sigma"

# Grab the needed subset of data
temp <- data.frame(smry$Freq_GHz, smry$max_S21_dB, smry$min_S21_dB, smry$mean_S21_dB, smry$sd_S21_dB)
names(temp) <- c("Frequency", "Max S21", "Min S21", "Mean S21", "SD S21")

# Create the mean + 6 sigma variable
temp <- temp %>% mutate(`Mean + 6 Sigma` = `Mean S21` - (coverage_factor * `SD S21`))

# Create the plot
p <- ggplot(data = temp, mapping = aes(x = Frequency)) +
     geom_line(aes(y = `Mean + 6 Sigma`), color = "black") +
     labs(x = "Frequency (GHz)", y = "Magnitude of S21 (dB)") +
     ggtitle(title) +
     theme_minimal() +
     theme(plot.title = element_text(hjust = 0.5))

# Add specs to the plot if desired
if(s21_spec == "low"){
  spec_table <- data.table(df_melt_S21$Frequency[which(df_melt_S21$Cycle == df_melt_S21$Cycle[1])], df_melt_S21$S21_spec_low[which(df_melt_S21$Cycle == df_melt_S21$Cycle[1])])
  names(spec_table) <- c("Frequency", "Spec")
  p <- p + geom_line(data = spec_table, aes(y = Spec), color = "red")
} else if (s21_spec == "mid"){
  spec_table <- data.table(df_melt_S21$Frequency[which(df_melt_S21$Cycle == df_melt_S21$Cycle[1])], df_melt_S21$S21_spec_mid[which(df_melt_S21$Cycle == df_melt_S21$Cycle[1])])
  names(spec_table) <- c("Frequency", "Spec")
  p <- p + geom_line(data = spec_table, aes(y = Spec), color = "red")
} else if (s21_spec == "high"){
  spec_table <- data.table(df_melt_S21$Frequency[which(df_melt_S21$Cycle == df_melt_S21$Cycle[1])], df_melt_S21$S21_spec_high[which(df_melt_S21$Cycle == df_melt_S21$Cycle[1])])
  names(spec_table) <- c("Frequency", "Spec")
  p <- p + geom_line(data = spec_table, aes(y = Spec), color = "red")
} else if (s21_spec == "Falcon"){
  spec_table <- data.table(df_melt_S21$Frequency[which(df_melt_S21$Cycle == df_melt_S21$Cycle[1])], df_melt_S21$S21_spec_falcon[which(df_melt_S21$Cycle == df_melt_S21$Cycle[1])])
  names(spec_table) <- c("Frequency", "Spec")
  p <- p + geom_line(data = spec_table, aes(y = Spec), color = "red")
}

      
# Load the Gore predicted loss data
# gore <- read_xlsx(path = "E:/Teradyne_WFH/Gore_Insertion_Loss_Curves.xlsx", sheet = 4)
# names(gore) <- c("Frequency", "Gauranteed Worst Loss")
# gore <- gore[which(gore$Frequency < 67),]
# p <- p + geom_line(data = gore, aes(y = `Gauranteed Worst Loss`), color = "black")



# Plot it (Dynamic tics enables scale changes when zooming; autorange=false enables a small buffer around the data instead of taking it to the edges of the plots)
# Generate the plot
p21mmm <- ggplotly(p, dynamicTicks = TRUE) %>% layout(xaxis = list(autorange = FALSE))
p21mmm <- config(p21mmm, modeBarButtonsToRemove = c("zoomIn2d", "zoomOut2d", "lasso2d", "select2d", "toggleSpikelines","autoScale2d"))
p21mmm
```
<center> TERADYNE CONFIDENTIAL DO NOT DISTRIBUTE </center>  



#### Plot 1.3: Max, Min, and Mean of S21

This plot is used to calculate and visualize the maximum, minimum, and mean of S21 at each frequency over the `r total_cycles` cycles preformed on the `r company` `r cable_name`:

```{r Plotting1.3, echo = FALSE, warning = FALSE}
# Standard deviation of S21 across frequencies

# Create the title
title <- "Insertion Loss Max, Min, and Mean"

# Grab the needed subset of data
temp <- data.frame(smry$Freq_GHz, smry$max_S21_dB, smry$min_S21_dB, smry$mean_S21_dB)
names(temp) <- c("Frequency", "Max S21", "Min S21", "Mean S21")

# Create the plot
p <- ggplot(data = temp, mapping = aes(x = Frequency)) +
     geom_line(aes(y = `Max S21`), color = "red") +
     labs(x = "Frequency (GHz)", y = "Magnitude of S21 (dB)") +
     ggtitle(title)# +

      
# Add the max and min lines to the plot
p <- p + geom_line(aes(y = `Min S21`), color = "blue") +
         geom_line(aes(y = `Mean S21`), color = "black") +
         #labs(x = "Frequency (GHz)", y = "Spec")
         theme(legend.position = "none") +
         theme_minimal() +
         theme(plot.title = element_text(hjust = 0.5))



# Add specs to the plot if desired
if(s21_spec == "low"){
  spec_table <- data.table(df_melt_S21$Frequency[which(df_melt_S21$Cycle == df_melt_S21$Cycle[1])], df_melt_S21$S21_spec_low[which(df_melt_S21$Cycle == df_melt_S21$Cycle[1])])
  names(spec_table) <- c("Frequency", "Spec")
  p <- p + geom_line(data = spec_table, aes(y = Spec), color = "red")
} else if (s21_spec == "mid"){
  spec_table <- data.table(df_melt_S21$Frequency[which(df_melt_S21$Cycle == df_melt_S21$Cycle[1])], df_melt_S21$S21_spec_mid[which(df_melt_S21$Cycle == df_melt_S21$Cycle[1])])
  names(spec_table) <- c("Frequency", "Spec")
  p <- p + geom_line(data = spec_table, aes(y = Spec), color = "red")
} else if (s21_spec == "high"){
  spec_table <- data.table(df_melt_S21$Frequency[which(df_melt_S21$Cycle == df_melt_S21$Cycle[1])], df_melt_S21$S21_spec_high[which(df_melt_S21$Cycle == df_melt_S21$Cycle[1])])
  names(spec_table) <- c("Frequency", "Spec")
  p <- p + geom_line(data = spec_table, aes(y = Spec), color = "red")
} else if (s21_spec == "Falcon"){
  spec_table <- data.table(df_melt_S21$Frequency[which(df_melt_S21$Cycle == df_melt_S21$Cycle[1])], df_melt_S21$S21_spec_falcon[which(df_melt_S21$Cycle == df_melt_S21$Cycle[1])])
  names(spec_table) <- c("Frequency", "Spec")
  p <- p + geom_line(data = spec_table, aes(y = Spec), color = "red")
}


# Load the Gore predicted loss data
# gore <- read_xlsx(path = "E:/Teradyne_WFH/Gore_Insertion_Loss_Curves.xlsx", sheet = 4)
# names(gore) <- c("Frequency", "Gauranteed Worst Loss")
# gore <- gore[which(gore$Frequency < 67),]
# p <- p + geom_line(data = gore, aes(y = `Gauranteed Worst Loss`), color = "black")



# Plot it (Dynamic tics enables scale changes when zooming; autorange=false enables a small buffer around the data instead of taking it to the edges of the plots)
# Generate the plot
p21mmm <- ggplotly(p, dynamicTicks = TRUE) %>% layout(xaxis = list(autorange = FALSE))
p21mmm <- config(p21mmm, modeBarButtonsToRemove = c("zoomIn2d", "zoomOut2d", "lasso2d", "select2d", "toggleSpikelines","autoScale2d"))
p21mmm
```
<center> TERADYNE CONFIDENTIAL DO NOT DISTRIBUTE </center>  



#### Plot 2.1: S21 Standard Deviation Over All Cycles

This plot is used to calculate and visualize the standard deviation of S21 at all frequencies over the `r total_cycles` cycles preformed on the `r company` `r cable_name`:

```{r Plotting2.1, echo = FALSE, warning = FALSE}
# Standard deviation of S21 across frequencies
coverage_factor <- 3

# Create the title
title <- "Insertion Loss Repeatability: Standard Deviation of S21"

# Grab the needed subset of data
temp <- data.frame(smry$Freq_GHz, smry$sd_S21_dB, smry$S21_Stdev_spec_high, smry$S21_Stdev_spec_low, smry$S21_Stdev_spec_falcon)
names(temp) <- c("Frequency", "Repeatability (dB)", "Current Spec", "Previous spec", "Spec")
temp$`Repeatability (dB)` <- temp$`Repeatability (dB)` * coverage_factor

# Create the plot
p <- ggplot(data = temp, mapping = aes(x = Frequency)) +
     geom_line(aes(y = `Repeatability (dB)`)) +
     labs(x = "Frequency (GHz)", y = "Standard Deviation of S21 (dB)") +
     ggtitle(title) +
     theme_minimal() + # this theme makes the plot very similar to the default plotly aesthetic
     theme(plot.title = element_text(hjust = 0.5))


      
# Add the spec line to the plot
if(s21_spec == "Falcon"){
  p <- p + geom_line(aes(y = `Spec`), color = "red") +
         theme(legend.position = "none")
} else {
  p <- p + geom_line(aes(y = `Current Spec`), color = "red") +
         geom_line(aes(y = `Previous spec`), color = "blue") +
         theme(legend.position = "none")
}




# Plot it
# Generate the plot
p21r <- ggplotly(p, dynamicTicks = TRUE) %>% layout(xaxis = list(autorange = FALSE))
p21r <- config(p21r, modeBarButtonsToRemove = c("zoomIn2d", "zoomOut2d", "lasso2d", "select2d", "toggleSpikelines","autoScale2d"))
p21r

#Pass or fail old (low) repeatability spec: `r if(sum(!smry$pass_S21_Stdev_spec_low) > 0){paste("FAILED")} else {paste("PASS")}`  
#Pass or fail new (high) repeatability spec: `r if(sum(!smry$pass_S21_Stdev_spec_high) > 0){paste("FAILED")} else {paste("PASS")}`


```

<center> TERADYNE CONFIDENTIAL DO NOT DISTRIBUTE </center>  


#### Plot 2.2: S21 Standard Deviation Calculated After Each Cycle

This plot is used to calculate and visualize the standard deviation of S21 at all frequencies over the `r total_cycles` cycles preformed on the `r company` `r cable_name`. Measurements were taken every `r cycs_between_meas` cycles for a total of `r length(list.files(pth))` measurements. The standard deviation was recalculated after every measurement to see how the standard deviation changed over time and if/when it failed the repeatability specification:

```{r Plotting2.2, echo = FALSE, warning = FALSE}
coverage_factor <- 3


#temp_df <- df[which(df$sd_by_cycle_s21 > 0),]

temp <- data.frame(df$Freq_GHz, df$sd_by_cycle_s21, df$S21_Stdev_spec_high, df$S21_Stdev_spec_low, df$S21_Stdev_spec_falcon, df$Cycle)
names(temp) <- c("Frequency","Repeatability","Current Spec", "Previous Spec", "Spec", "Cycle")
temp <- temp[which(temp$Repeatability > 0),]
temp$Repeatability <- temp$Repeatability * coverage_factor

# Create the plot title
title <- "Insertion Loss Repeatability: Standard Deviation of S21 Calculated Every Cycle"

# Create the highlight key
h <- highlight_key(temp, ~Cycle)


# Create the plot
p <- ggplot(data = h, mapping = aes(x = Frequency)) + 
  geom_line(aes(y = Repeatability, color = Cycle)) +
  labs(x = "Frequency (GHz)", y = "Standard Deviation of S21 (dB)", col = "Cycle") + 
  ggtitle(title) +
  scale_color_gradientn(colors = rainbow(10)) +
  guides(fill=guide_legend(title="Cycle")) +
  theme_minimal() + # this theme makes the plot very similar to the default plotly aesthetic
  theme(plot.title = element_text(hjust = 0.5))


# create a mini data table for the specs so there are not hundreds of spec lines overlayed and taking up storage space
m <- min(temp$Cycle)
spec <- temp[which(temp$Cycle == m),]  

# Add the spec line to the plot
if(s21_spec == "Falcon"){
  p <- p + geom_line(aes(y = `Spec`), color = "red") +
         theme(legend.position = "none")
} else {
  p <- p + geom_line(aes(y = `Current Spec`), color = "red") +
         geom_line(aes(y = `Previous spec`), color = "blue") +
         theme(legend.position = "none")
}

# Generate the plot
p21rcyc <- ggplotly(p, dynamicTicks = TRUE, tooltip = c("Frequency", "Repeatability", "Cycle", "Spec")) %>% layout(xaxis = list(autorange = FALSE))
p21rcyc <- config(p21rcyc, modeBarButtonsToRemove = c("zoomIn2d", "zoomOut2d", "lasso2d", "select2d", "toggleSpikelines","autoScale2d"))
p21rcyc <- highlight(p21rcyc, on = "plotly_click", off = "plotly_doubleclick", color = "black")

# Display the plot
p21rcyc

# Create pass/fail statement for low spec
if(sum(df$sd_by_cycle_s21 > df$S21_Stdev_spec_low) > 0){
  pfl <- paste("FAILED LOW SPEC ON CYCLE ", df$Cycle[which(df$sd_by_cycle_s21 > df$S21_Stdev_spec_low)[1]], " OUT OF ", total_cycles, " CYCLES", sep = "")
} else {pfl <- paste("PASS")}

# Create pass/fail statement for high spec
if(sum(df$sd_by_cycle_s21 > df$S21_Stdev_spec_high, na.rm = TRUE) > 0){
  pfh <- paste("FAILED HIGH SPEC ON CYCLE ", df$Cycle[which(df$sd_by_cycle_s21 > df$S21_Stdev_spec_high)[1]],  " OUT OF ", total_cycles, " CYCLES", sep = "")
} else {pfh <- paste("PASS")}


#Pass or fail old (low) repeatability spec: `r pfl`        
#Pass or fail new (high) repeatability spec: `r pfh`


```

<center> TERADYNE CONFIDENTIAL DO NOT DISTRIBUTE </center>  



#### Plot 3.1: S21 Data at `r closest_freq_low` GHz

This plot is the same as the above plot but the data was taken at `r closest_freq_low` GHz instead of `r closest_freq_high` GHz. This plot can be used to get an idea of how the cable is degrading over time.

```{r Plotting3.1, echo = FALSE, warning = FALSE}
# Plot all S21 from all measurements
df_melt_S21 <- melt(df, id.vars = c("Freq_GHz","Cycle","filetimes"), measure.vars = c("S21_dB"))

df_melt_S21_select_freq <- df_melt_S21[which(df_melt_S21$`Freq_GHz` == closest_freq_low),]
names(df_melt_S21_select_freq) <- c("Frequency", "Cycle", "Time", "variable", "Insertion Loss")

# Get the temperature data for the time period that the test was ran
start_time <- df_melt_S21_select_freq$Time[1]
end_time <- df_melt_S21_select_freq$Time[nrow(df_melt_S21_select_freq)]
temp_temperature_df <- temperature_df[which(temperature_df$Time >= start_time & temperature_df$Time <= end_time),]

# Create the plot title
title <- paste("S21 Data at ", closest_freq_low, " GHz over ", total_cycles, " cycles", sep = "")  


# # OLD CODE
#####
# 
# # Create the plot
# #p <- ggplot(data = df_melt_S21_select_freq, mapping = aes(x = Cycle, y = `Insertion Loss`)) + 
# p <- ggplot() + 
#      geom_line(data = df_melt_S21_select_freq, aes(x = Time, y = `Insertion Loss`)) +
#      geom_line(data = temp_temperature_df, aes(x = Time, y = Temperature)) +
#      #labs(x = "Cycle", y = "S21") + 
#      #xlab("Measurement Time") + 
#      #ylab("Magnitude of S21 (dB)") + 
#      ggtitle(title) +
#      #theme_minimal() + # this theme makes the plot very similar to the default plotly aesthetic
#      #theme(plot.title = element_text(hjust = 0.5)) +
#      scale_y_continuous(name = "Magnitude of S21 (dB)", sec.axis = sec_axis(~temperature_df$Temperature, name="Second Axis"))
# p
#####


# Create the plot
p <- plot_ly()

# Add the first trace
p <- p %>% add_trace(x = df_melt_S21_select_freq$Time, y = df_melt_S21_select_freq$`Insertion Loss`, 
                     name = "Insertion Loss", mode = "lines", type = "scatter", color = I("black"), hoverinfo = "text",
                     text = ~paste('</br> Cycle: ', df_melt_S21_select_freq$Cycle,
                                   '</br> Loss: ', df_melt_S21_select_freq$`Insertion Loss`,
                                   '</br> Time: ', df_melt_S21_select_freq$Time)) 

# Specify info for the second y-axis
y2 <- list(
  tickfont = list(color = "red"),
  overlaying = "y",
  side = "right",
  title = "Temperature (C)",
  automargin = TRUE,
  yaxis = list(
    zerolinecolor = '#ffff',
    #zerolinewidth = 2,
    gridcolor = '0000'))

# Add the temperature trace
p <- p %>% add_trace(x = temp_temperature_df$Time, y = temp_temperature_df$Temperature, 
                     name = "Temperature", yaxis = "y2", mode = "lines", type = "scatter", color = I("red"), hoverinfo = "text",
                     text = ~paste('</br> Temperature (C): ', temp_temperature_df$Temperature,
                                   '</br> Time: ', temp_temperature_df$Time))

# Specify layout and labling information
p <- p %>% layout(
  title = title, 
  yaxis2 = y2,
  xaxis = list(title="Time"),
  yaxis = list(title="Insertion Loss"),
  showlegend = FALSE
)
# %>%
#   layout(plot_bgcolor='#e5ecf6',
#           xaxis = list(
#             zerolinecolor = '#ffff',
#             zerolinewidth = 2,
#             gridcolor = 'ffff'),
#           yaxis = list(
#             zerolinecolor = '#ffff',
#             zerolinewidth = 2,
#             gridcolor = 'ffff'),
#           showlegend = FALSE
#           )



# Generate the plot
#p21freql <- ggplotly(p, dynamicTicks = TRUE) %>% layout(xaxis = list(autorange = FALSE))
p21freql <- config(p, modeBarButtonsToRemove = c("zoomIn2d", "zoomOut2d", "lasso2d", "select2d", "toggleSpikelines","autoScale2d"))
p21freql
```
<center> TERADYNE CONFIDENTIAL DO NOT DISTRIBUTE </center>  



#### Plot 3.2: S21 Data at `r closest_freq_high` GHz

This plot is used to visualize the S21 data taken at `r closest_freq_high` GHz over the course of the `r length(list.files(pth))` measurements on the `r company` `r cable_name`. This plot can be used to get an idea of how the cable is degrading over time.

```{r Plotting3.2, echo = FALSE}
### Plot all S21 from all measurements###

# Load the data
df_melt_S21 <- melt(df, id.vars = c("Freq_GHz","Cycle","filetimes"), measure.vars = c("S21_dB"))

# Select the desired data and rename
df_melt_S21_select_freq <- df_melt_S21[which(df_melt_S21$`Freq_GHz` == closest_freq_high),]
names(df_melt_S21_select_freq) <- c("Frequency", "Cycle","Time", "variable", "Insertion Loss")


# Get the temperature data for the time period that the test was ran
start_time <- df_melt_S21_select_freq$Time[1]
end_time <- df_melt_S21_select_freq$Time[nrow(df_melt_S21_select_freq)]
temp_temperature_df <- temperature_df[which(temperature_df$Time >= start_time & temperature_df$Time <= end_time),]

# Create the plot title
title <- paste("S21 Data at ", closest_freq_high, " GHz over ", total_cycles, " cycles", sep = "")  


# OLD CODE
#####
# 
# p <- ggplot(data = df_melt_S21_select_freq, mapping = aes(x = Cycle, y = `Insertion Loss`)) + 
#      geom_line() +
#      labs(x = "Cycle", y = "S21") + 
#      xlab("Cycle Number") + 
#      ylab("Magnitude of S21 (dB)") + 
#      ggtitle(title) +
#      theme_minimal() + # this theme makes the plot very similar to the default plotly aesthetic
#      theme(plot.title = element_text(hjust = 0.5))
# 
#####

# Create the plot
p <- plot_ly()

# Add the first trace
p <- p %>% add_trace(x = df_melt_S21_select_freq$Time, y = df_melt_S21_select_freq$`Insertion Loss`, 
                     name = "Insertion Loss", mode = "lines", type = "scatter", color = I("black"), hoverinfo = "text",
                     text = ~paste('</br> Cycle: ', df_melt_S21_select_freq$Cycle,
                                   '</br> Loss: ', df_melt_S21_select_freq$`Insertion Loss`,
                                   '</br> Time: ', df_melt_S21_select_freq$Time)) 

# Specify info for the second y-axis
second_axis <- list(
  tickfont = list(color = "red"),
  overlaying = "y",
  side = "right",
  title = "Temperature (C)",
  automargin = TRUE)

# Add the temperature trace
p <- p %>% add_trace(x = temp_temperature_df$Time, y = temp_temperature_df$Temperature, 
                     name = "Temperature", yaxis = "y2", mode = "lines", type = "scatter", color = I("red"), hoverinfo = "text",
                     text = ~paste('</br> Temperature (C): ', temp_temperature_df$Temperature,
                                   '</br> Time: ', temp_temperature_df$Time))

# Specify layout and labling information
p <- p %>% layout(
  title = title, 
  yaxis2 = second_axis,
  xaxis = list(title="Time"),
  yaxis = list(title="Insertion Loss"),
  showlegend = FALSE
)
# %>%
#   layout(plot_bgcolor='#e5ecf6',
#           xaxis = list(
#             zerolinecolor = '#ffff',
#             zerolinewidth = 2,
#             gridcolor = 'ffff'),
#           yaxis = list(
#             zerolinecolor = '#ffff',
#             zerolinewidth = 2,
#             gridcolor = 'ffff'),
#           showlegend = FALSE
#           )



# Generate the plot
#p21freqh <- ggplotly(p, dynamicTicks = TRUE) %>% layout(xaxis = list(autorange = FALSE))
p21freqh <- config(p, modeBarButtonsToRemove = c("zoomIn2d", "zoomOut2d", "lasso2d", "select2d", "toggleSpikelines","autoScale2d"))
p21freqh
```
<center> TERADYNE CONFIDENTIAL DO NOT DISTRIBUTE </center>  



### Return Loss Analysis

#### Plot 4.1.1: All S11 Data

This plot is used to visualize the S11 data taken over the course of the `r total_cycles` mating cycles on the `r company` `r cable_name`. The color of each trace corresponds to which mating cycle the data sample was taken on with red indicating earlier measurements and purple indicating later measurements.


```{r Plotting4.1.1, echo = FALSE, warning = FALSE}
# Load the data
df_melt_S11 <- melt(df, id.vars = c("Freq_GHz","Cycle","S11_spec_falcon","S11_spec_mx44", "S11_spec_low","S11_spec_mid","S11_spec_high"), measure.vars = c("S11_dB"))
names(df_melt_S11) <- c("Frequency", "Cycle", "S11_spec_falcon","S11_spec_mx44", "S11_spec_low","S11_spec_mid","S11_spec_high", "variable", "Return Loss")

# Indicate which variable should be used to group points together when trying to highlight a trace
h <- highlight_key(df_melt_S11, ~Cycle)

# Create the plot
title <- paste(company, " ", cable_name, ": S11 Data over ", total_cycles, " cycles", sep = "")  
p <- ggplot(data = h, mapping = aes(x = Frequency)) + 
  geom_line(aes(y = `Return Loss`, color = Cycle)) +
  #xlim(0,43.5) +
  labs(x = "Frequency (GHz)", y = "Magnitude of S11 (dB)", col = "Cycle") +
  ggtitle(title) +
  scale_color_gradientn(colors = rainbow(10)) +
  theme_minimal() + # this theme makes the plot very similar to the default plotly aesthetic
  theme(plot.title = element_text(hjust = 0.5))

  #theme(plot.title = element_text(size = 18, face = "bold"), axis.title = element_text(size = 18), axis.text = element_text(size = 14), 
        #legend.text = element_text(size=14), legend.title=element_text(size=14))

# Add specs to the plot if desired
if(s11_spec == "low"){
  Spec <- df_melt_S11$S11_spec_low
  p <- p + geom_line(aes(y = Spec), color = "red")
} else if (s11_spec == "mid"){
  Spec <- df_melt_S11$S11_spec_mid
  p <- p + geom_line(aes(y = Spec), color = "red")
} else if (s11_spec == "high"){
  Spec <- df_melt_S11$S11_spec_high
  p <- p + geom_line(aes(y = Spec), color = "red")
} else if (s11_spec == "mx44"){
  Spec <- df_melt_S11$S11_spec_mx44
  p <- p + geom_line(aes(y = Spec), color = "red")
} else if (s11_spec == "Falcon"){
  Spec <- df_melt_S11$S11_spec_falcon
  p <- p + geom_line(aes(y = Spec), color = "red")
}



# Generate the plot
p <- ggplotly(p, dynamicTicks = TRUE, tooltip = c("Frequency", "Return Loss", "Cycle", "Spec")) %>% layout(xaxis = list(autorange = FALSE))
p <- config(p, modeBarButtonsToRemove = c("zoomIn2d", "zoomOut2d", "lasso2d", "select2d", "toggleSpikelines","autoScale2d"))

# Enable highliting when a trace is clicked and change the selected trace to black
p <- highlight(p, on = "plotly_click", off = "plotly_doubleclick", color = "black")


p
```
Pass or fail S11 spec: `r if(sum(!df$pass_S11_spec) > 0){paste("FAILED AT CYCLE ", df$Cycle[which(df$pass_S11_spec == FALSE)[1]], " OUT OF ", total_cycles, " CYCLES", sep = "")} else {paste("PASS")}`

<center> TERADYNE CONFIDENTIAL DO NOT DISTRIBUTE </center>  


#### Plot 4.1.2: All S11 Data Animation

This plot is the same as the previous plot, but allows for the user to animate the traces to see how they evolve over time, or to look at any individual trace on its own.


```{r Plotting4.1.2, echo = FALSE, warning = FALSE}
# Load the data
df_melt_S11 <- melt(df, id.vars = c("Freq_GHz","Cycle","S11_spec_falcon","S11_spec_mx44", "S11_spec_low","S11_spec_mid","S11_spec_high"), measure.vars = c("S11_dB"))
names(df_melt_S11) <- c("Frequency", "Cycle", "S11_spec_falcon","S11_spec_mx44", "S11_spec_low","S11_spec_mid","S11_spec_high", "variable", "Return Loss")


# Create the plot
title <- paste(company, " ", cable_name, ": S11 Data over ", total_cycles, " cycles", sep = "")  
p <- ggplot(data = h, mapping = aes(x = Frequency)) + 
  geom_line(aes(y = `Return Loss`, frame = Cycle)) +
  #xlim(0,43.5) +
  labs(x = "Frequency (GHz)", y = "Magnitude of S11 (dB)", col = "Cycle") +
  ggtitle(title) +
  scale_color_gradientn(colors = rainbow(10)) +
  theme_minimal() + # this theme makes the plot very similar to the default plotly aesthetic
  theme(plot.title = element_text(hjust = 0.5))

  #theme(plot.title = element_text(size = 18, face = "bold"), axis.title = element_text(size = 18), axis.text = element_text(size = 14), 
        #legend.text = element_text(size=14), legend.title=element_text(size=14))

# Add specs to the plot if desired
if(s11_spec == "low"){
  Spec <- df_melt_S11$S11_spec_low
  p <- p + geom_line(aes(y = Spec), color = "red")
} else if (s11_spec == "mid"){
  Spec <- df_melt_S11$S11_spec_mid
  p <- p + geom_line(aes(y = Spec), color = "red")
} else if (s11_spec == "high"){
  Spec <- df_melt_S11$S11_spec_high
  p <- p + geom_line(aes(y = Spec), color = "red")
} else if (s11_spec == "mx44"){
  Spec <- df_melt_S11$S11_spec_mx44
  p <- p + geom_line(aes(y = Spec), color = "red")
} else if (s11_spec == "Falcon"){
  Spec <- df_melt_S11$S11_spec_falcon
  p <- p + geom_line(aes(y = Spec), color = "red")
}


# Generate the plot
p <- ggplotly(p, dynamicTicks = TRUE, tooltip = c("Frequency", "Return Loss", "Cycle", "Spec")) %>% layout(xaxis = list(autorange = FALSE))
p <- config(p, modeBarButtonsToRemove = c("zoomIn2d", "zoomOut2d", "lasso2d", "select2d", "toggleSpikelines","autoScale2d"))
p <- animation_opts(p, frame = 100, transition = 1, redraw = FALSE)

p
```
Pass or fail S11 spec: `r if(sum(!df$pass_S11_spec) > 0){paste("FAILED AT CYCLE ", df$Cycle[which(df$pass_S11_spec == FALSE)[1]], " OUT OF ", total_cycles, " CYCLES", sep = "")} else {paste("PASS")}`

<center> TERADYNE CONFIDENTIAL DO NOT DISTRIBUTE </center>  





#### Plot 4.2: Max, Min, and Mean of S11

This plot is used to calculate and visualize the maximum, minimum, and mean of S11 at each frequency over the `r total_cycles` cycles preformed on the `r company` `r cable_name`:

```{r Plotting4.2, echo = FALSE, warning = FALSE}
# Standard deviation of S11 across frequencies

# Create the title
title <- "Return Loss Max, Min, and Mean"

# Grab the needed subset of data
temp <- data.frame(smry$Freq_GHz, smry$max_S11_dB, smry$min_S11_dB, smry$mean_S11_dB)
names(temp) <- c("Frequency", "Max S11", "Min S11", "Mean S11")

# Create the plot
p <- ggplot(data = temp, mapping = aes(x = Frequency)) +
     geom_line(aes(y = `Max S11`), color = "red") +
     labs(x = "Frequency (GHz)", y = "Magnitude of S11 (dB)") +
     ggtitle(title) +
     theme_minimal() + # this theme makes the plot very similar to the default plotly aesthetic
     theme(plot.title = element_text(hjust = 0.5))


      
# Add the spec line to the plot
p <- p + geom_line(aes(y = `Min S11`), color = "blue") +
         geom_line(aes(y = `Mean S11`), color = "black") +
         #labs(x = "Frequency (GHz)", y = "Spec")
         theme(legend.position = "none")

# Plot it
# Generate the plot
p11mmm <- ggplotly(p, dynamicTicks = TRUE) %>% layout(xaxis = list(autorange = FALSE))
p11mmm <- config(p11mmm, modeBarButtonsToRemove = c("zoomIn2d", "zoomOut2d", "lasso2d", "select2d", "toggleSpikelines","autoScale2d"))
p11mmm
```

<center> TERADYNE CONFIDENTIAL DO NOT DISTRIBUTE </center>  

#### Plot 5: VSWR
```{r Plotting 5, echo = FALSE, warning = FALSE}
# Plot VSWR Calculations

df_melt_vswr <- melt(df, id.vars = c("Freq_GHz","Cycle"), measure.vars = c("VSWR"))
names(df_melt_vswr) <- c("Frequency", "Cycle", "variable", "VSWR")

# Indicate which variable should be used to group points together when trying to highlight a trace
h <- highlight_key(df_melt_vswr, ~Cycle)

    
title <- "VSWR vs Frequency"
p <- ggplot(data = h, mapping = aes(x = Frequency, y = VSWR, color = Cycle)) +
  geom_line(size = 0.5) +
  labs(x = "Frequency (GHz)", y = "VSWR", col = "Cycle") +
  ggtitle(title) +
  scale_color_gradientn(colors = rainbow(6)) +
  theme_minimal() + # this theme makes the plot very similar to the default plotly aesthetic
  theme(plot.title = element_text(hjust = 0.5))


pvswr <- ggplotly(p, dynamicTicks = TRUE, tooltip = c("Frequency", "VSWR", "Cycle", "Spec"))

# Enable highliting when a trace is clicked and change the selected trace to black
pvswr <- highlight(pvswr, on = "plotly_click", off = "plotly_doubleclick", color = "black")

pvswr

```





```{r Plotting5.1, echo= FALSE, warning = FALSE, include = FALSE}
# Standard deviation of S11 across frequencies

#This plot is used to calculate and visualize the standard deviation of S11 at all frequencies over the `r total_cycles` cycles preformed on the `r company` `r cable_name`:

if(num_cables == 1){
  #title <- paste(company, " ", cable_name, " Insertion Loss Repeatability: Standard Deviation of S11 Across Frequencies", sep = "")  
  title <- paste(company, " ", " Return Loss Repeatability: Standard Deviation of S11 Across Frequencies", sep = "")  
  
  p <- qplot(`Freq_GHz`, sd_S11_dB, data = smry, geom = "line", main = title, ylab = "Standard Deviation of S11 (dB)") + 
    #xlim(0,43.5) +
    xlab("Frequency (GHz)") + 
    ylab("Standard Deviation of S11 (dB)") + 
    #theme(plot.title = element_text(size = 18, face = "bold"), axis.title = element_text(size = 18), axis.text = element_text(size = 14), legend.position = "none")
    theme(legend.position = "none") +
    theme_minimal() + # this theme makes the plot very similar to the default plotly aesthetic
    theme(plot.title = element_text(hjust = 0.5))

  
  # Generate the plot
  p <- ggplotly(p, dynamicTicks = TRUE) %>% layout(xaxis = list(autorange = FALSE))
  p <- config(p, modeBarButtonsToRemove = c("zoomIn2d", "zoomOut2d", "lasso2d", "select2d", "toggleSpikelines","autoScale2d"))
  p
}


```
<center> TERADYNE CONFIDENTIAL DO NOT DISTRIBUTE </center>  




#### Plot 6.1: S11 Data at `r closest_freq_low` GHz

This plot is the same as the above plot but the data was taken at `r closest_freq_low` GHz instead of `r closest_freq_low` GHz. There are `r total_cycles` cycles included in this plot. This plot can be used to get an idea of how the cable is degrading over time.

```{r Plotting6.1, echo = FALSE}
# Plot all S11 from all measurements
df_melt_S11 <- melt(df, id.vars = c("Freq_GHz","Cycle"), measure.vars = c("S11_dB"))

names(df_melt_S11) <- c("Frequency", "Cycle", "variable", "Return Loss")

df_melt_S11_select_freq <- df_melt_S11[which(df_melt_S11$`Frequency` == closest_freq_low),]

#title <- paste(company, " ", cable_name, ": S11 Data at ", closest_freq_low, " GHz over ", total_cycles, " cycles", sep = "")  
title <- paste(company, " ", ": S11 Data at ", closest_freq_low, " GHz over ", total_cycles, " cycles", sep = "")  

p <- ggplot(data = df_melt_S11_select_freq, mapping = aes(x = Cycle, y = `Return Loss`)) + 
      #geom_line(size = 0.5) +
      geom_line() +
      xlab("Cycle Number") + 
      ylab("Magnitude of S11 (dB)") + 
      ggtitle(title) +
      theme_minimal() + # this theme makes the plot very similar to the default plotly aesthetic
      theme(plot.title = element_text(hjust = 0.5))

      #theme(plot.title = element_text(size = 18, face = "bold"), axis.title = element_text(size = 18), axis.text = element_text(size = 14), 
            #legend.text = element_text(size=14), legend.title=element_text(size=14))

# Generate the plot
p <- ggplotly(p, dynamicTicks = TRUE) %>% layout(xaxis = list(autorange = FALSE))
p <- config(p, modeBarButtonsToRemove = c("zoomIn2d", "zoomOut2d", "lasso2d", "select2d", "toggleSpikelines","autoScale2d"))
p
```
<center> TERADYNE CONFIDENTIAL DO NOT DISTRIBUTE </center>  



#### Plot 6.2: S11 Data at `r closest_freq_high` GHz

This plot is used to visualize the S11 data taken at `r closest_freq_high` GHz over the course of the `r total_cycles` cycles on the `r company` `r cable_name`. This plot can be used to get an idea of how the cable is degrading over time.

```{r Plotting6.2, echo = FALSE}
# Plot all S11 from all measurements
df_melt_S11 <- melt(df, id.vars = c("Freq_GHz","Cycle"), measure.vars = c("S11_dB"))

names(df_melt_S11) <- c("Frequency", "Cycle", "variable", "Return Loss")

df_melt_S11_select_freq <- df_melt_S11[which(df_melt_S11$`Frequency` == closest_freq_high),]

#title <- paste(company, " ", cable_name, ": S11 Data at ", closest_freq_high, " GHz over ", total_cycles, " cycles", sep = "")  
title <- paste(company, " ", ": S11 Data at ", closest_freq_high, " GHz over ", total_cycles, " cycles", sep = "")  

p <- ggplot(data = df_melt_S11_select_freq, mapping = aes(x = Cycle, y = `Return Loss`)) + 
  #geom_line(size = 0.5) +
  geom_line() +
  xlab("Cycle Number") + 
  ylab("Magnitude of S11 (dB)") + 
  ggtitle(title) +
  theme_minimal() + # this theme makes the plot very similar to the default plotly aesthetic
  theme(plot.title = element_text(hjust = 0.5))

  #theme(plot.title = element_text(size = 18, face = "bold"), axis.title = element_text(size = 18), axis.text = element_text(size = 14), 
        #legend.text = element_text(size=14), legend.title=element_text(size=14))

# Generate the plot
p <- ggplotly(p, dynamicTicks = TRUE) %>% layout(xaxis = list(autorange = FALSE))
p <- config(p, modeBarButtonsToRemove = c("zoomIn2d", "zoomOut2d", "lasso2d", "select2d", "toggleSpikelines","autoScale2d"))
p
```
<center> TERADYNE CONFIDENTIAL DO NOT DISTRIBUTE </center>  




#### Plot 7.1: Phase at `r closest_freq_high` GHz

This plot is used to visualize the phase of the `r company` `r cable_name` insertion loss measurements at `r closest_freq_high` GHz over the `r total_cycles` cycles in this data set. 

```{r Plotting7.1, echo = FALSE}

#This section calculates and plots the average electrical length for the S21 measurements based on the S21 phase measurements at each frequency. The equation used to calculate electrical length is: e_length = (S21 phase / 2pi) / (Frequency * 360)

# Plot all S21 from all measurements
df_melt_S21 <- melt(df, id.vars = c("Freq_GHz","Cycle"), measure.vars = c("S21_Phase_Deg"))
names(df_melt_S21) <- c("Frequency", "Cycle","variable", "Phase")
df_melt_S21_rev <- df_melt_S21[which(df_melt_S21$`Frequency` == closest_freq_high),]


# Calculate the electrical length
# lambda <- 300000000 / closest_freq_high
# names(df_melt_S11) <- c("Frequency", "Cycle", "Return Loss")
# degrees <- df_melt_S21_rev$value * (180 / pi)
# e_length <- (degrees / 360) * lambda
# cbind it to the data frame
# df_melt_S11_rev <- cbind(df_melt_S21_rev, e_length)


# Create the plot title
#title <- paste(company, " ", cable_name, ": S21 Phase at ", closest_freq_high, " over ", total_cycles, " Cycles", sep = "")
title <- paste(company, " ", ": S21 Phase at ", closest_freq_high, " over ", total_cycles, " Cycles", sep = "")

p <- ggplot(data = df_melt_S21_rev, mapping = aes(x = Cycle, y = Phase)) +
      #geom_point() +
      geom_line() +
      xlab("Number of Cycles") +
      ylab("Phase of S21 (Degrees)") +
      ggtitle(title) +
      #theme(plot.title = element_text(size = 18, face = "bold"), axis.title = element_text(size = 18), axis.text = element_text(size = 14), 
            #legend.position = "none")
      theme(legend.position = "none") +
      theme_minimal() + # this theme makes the plot very similar to the default plotly aesthetic
      theme(plot.title = element_text(hjust = 0.5))


# Generate the plot
p <- ggplotly(p, dynamicTicks = TRUE) %>% layout(xaxis = list(autorange = FALSE))
p <- config(p, modeBarButtonsToRemove = c("zoomIn2d", "zoomOut2d", "lasso2d", "select2d", "toggleSpikelines","autoScale2d"))
p
```
<center> TERADYNE CONFIDENTIAL DO NOT DISTRIBUTE </center>  


 


```{r Plotting7.2, echo = FALSE, warning = FALSE}
# Standard deviation of S21 across frequencies


#### Plot 7.2: Repeatability of Phase 

#This plot is used to visualize the repeatability of the `r company` `r cable_name` insertion loss phase measurements at over the `r total_cycles` cycles in this data set.


if(num_cables == 1){
  # Grab the needed subset of data
  temp <- group_by(df,`Freq_GHz`) %>%
    summarise(sd_S21_Phase_Deg = sd(abs(S21_Phase_Deg)))
  names(temp) <- c("Frequency", "Repeatability (Degrees)")
  
  # Create the title
  title <- "Insertion Loss Phase Repeatability: Standard Deviation of S21 Phase"
  
  # Create the plot
  p <- ggplot(data = temp, mapping = aes(x = Frequency)) +
       geom_line(aes(y = `Repeatability (Degrees)`)) +
       labs(x = "Frequency (GHz)", y = "Standard Deviation of S21 Phase (Degrees)") +
       ggtitle(title) +
       theme_minimal() + # this theme makes the plot very similar to the default plotly aesthetic
       theme(plot.title = element_text(hjust = 0.5))

  
  # Plot it
  # Generate the plot
  p21pr <- ggplotly(p, dynamicTicks = TRUE) %>% layout(xaxis = list(autorange = FALSE))
  p21pr <- config(p21pr, modeBarButtonsToRemove = c("zoomIn2d", "zoomOut2d", "lasso2d", "select2d", "toggleSpikelines","autoScale2d"))
  p21pr
}


```





```{r Plotting7.3, echo = FALSE, warning = FALSE}

#### Plot 7.3: S21 Phase Standard Deviation Calculated After Each Cycle

#This plot is used to calculate and visualize the standard deviation of S21 phase at all frequencies over the `r total_cycles` cycles preformed on the `r company` `r cable_name`. Measurements were taken every `r cycs_between_meas` cycles for a total of `r length(list.files(pth))` measurements. The standard deviation was recalculated after every measurement to see how the standard deviation changed over time. This plot is removed if data from multiple cables are included in analysis.



if(num_cables == 1){
  temp_df <- df[which(df$sd_by_cycle_phase > 0),]

  temp <- data.frame(df$Freq_GHz, df$sd_by_cycle_phase, df$Cycle)
  names(temp) <- c("Frequency","Repeatability", "Cycle")
  temp <- temp[which(temp$Repeatability > 0),]
  
  # Create the highlight key
  h <- highlight_key(temp, ~Cycle)

  
  # Create the plot title
  title <- "Phase Repeatability: Standard Deviation of S21 Phase Calculated Every Cycle"
  
  # Create the plot
  p <- ggplot(data = h, mapping = aes(x = Frequency)) + 
    geom_line(aes(y = Repeatability, color = Cycle)) +
    labs(x = "Frequency (GHz)", y = "Standard Deviation of S21 Phase (Degrees)", col = "Cycle") + 
    ggtitle(title) +
    scale_color_gradientn(colors = rainbow(10)) +
    guides(fill=guide_legend(title="Cycle")) +
    theme_minimal() + # this theme makes the plot very similar to the default plotly aesthetic
    theme(plot.title = element_text(hjust = 0.5))

  
  
  # Generate the plot
  p21rcyc <- ggplotly(p, dynamicTicks = TRUE, tooltip = c("Frequency", "Repeatability", "Cycle")) %>% layout(xaxis = list(autorange = FALSE))
  p21rcyc <- config(p21rcyc, modeBarButtonsToRemove = c("zoomIn2d", "zoomOut2d", "lasso2d", "select2d", "toggleSpikelines","autoScale2d"))
  p21rcyc <- highlight(p21rcyc, on = "plotly_click", off = "plotly_doubleclick", color = "black")
  p21rcyc
}


```






```{r Plotting 8.2, echo = FALSE, warning = FALSE}
# Plot Phase Calculations

df_melt_phase <- melt(df, id.vars = c("Freq_GHz","Cycle"), measure.vars = c("S21_Phase_Deg"))
names(df_melt_phase) <- c("Frequency", "Cycle", "variable", "Phase")

# Create the highlight key
h <- highlight_key(df_melt_phase, ~Cycle)

    
title <- "Phase vs Frequency"
p <- ggplot(data = h, mapping = aes(x = Frequency, y = Phase, color = Cycle)) +
  geom_line(size = 0.5) +
  labs(x = "Frequency (GHz)", y = "Phase", col = "Cycle") +
  ggtitle(title) +
  scale_color_gradientn(colors = rainbow(10))

pphase <- ggplotly(p, dynamicTicks = TRUE)
pphase <- highlight(pphase, on = "plotly_click", off = "plotly_doubleclick", color = "black")
pphase

```


```{r 3D S21 Plot, echo = FALSE, warning = FALSE}

#### 3D S21 Plot
#This is an interactive 3D plot of S21 that shows S21 plotted normally on the Y and Z axis with the cycle count on the X axis.


plotly_melt <- melt(df, id.vars = c("Freq_GHz","Cycle","meas"), measure.vars = c("S21_dB"))
plotly_melt <- data.frame(plotly_melt)
#plotly_melt$Cycle <- as.integer(plotly_melt$Cycle)

#setattr(plotly_melt, "row.names", c(paste(rownames(plotly_melt),plotly_melt$Cycle)))

p <- plot_ly(x = plotly_melt$Cycle[which(plotly_melt$meas == 1)], 
             y = plotly_melt$Freq_GHz[which(plotly_melt$meas == 1)], 
             z = plotly_melt$value[which(plotly_melt$meas == 1)], type = 'scatter3d', mode = 'lines', opacity = 1, 
             color = plotly_melt$Cycle[which(plotly_melt$meas == 1)], line = list(reverscale = TRUE)) %>% 
    layout(
      title = "Interactive 3D Plot of S21",
      scene = list(
        xaxis = list(title = "Cycle"),
        yaxis = list(title = "Frequency (GHz)"),
        zaxis = list(title = "S21 Magnitude (dB)")
    ))


for( i in 2:length(unique(plotly_melt$meas))){
  p <- add_trace(p, x = plotly_melt$Cycle[which(plotly_melt$meas == i)],
                    y = plotly_melt$Freq_GHz[which(plotly_melt$meas == i)], 
                    z = plotly_melt$value[which(plotly_melt$meas == i)], type = 'scatter3d', mode = 'lines', opacity = 1, 
                    color = plotly_melt$Cycle[which(plotly_melt$meas == i)], line = list(reverscale = TRUE))
}


p <- p %>% layout(showlegend = FALSE)
p <- p %>% config(modeBarButtonsToRemove = c("zoomIn2d", "zoomOut2d", "lasso2d", "select2d", "toggleSpikelines","autoScale2d"))
p

```
<center> TERADYNE CONFIDENTIAL DO NOT DISTRIBUTE </center>  












































```{r Plotting7.2vect, echo = FALSE, warning = FALSE, eval = FALSE}


#### Plot 7.2: Vector Error Magnitude of S11

#This plot is used to visualize the `r company` `r cable_name` vector error calculations over the `r total_cycles` cycles in this data set. The vector error is calculated by finding the mean of S11 over the whole frequency range, and subtracting the mean S11 value from every individual S11 measurement for each measured frequency. Essentially this is measuring the deviation from the mean for every single measurement. 



##############################################
#### Calculate the Vector Error Magnitude ####

# Create the data frame that holds the vector error data
df_ve <- df

# Calculate the average S11RE and S11IM values
S11_avg <- group_by(df_ve, `Freq_GHz`) %>% 
  summarise(S11RE_avg = mean(`S11_Real`),
            S11IM_avg = mean(`S11_Img`))

# Calculate the error values for each data point
S11RE_err <- c(0)
S11IM_err <- c(0)
for(i in 1:nrow(df_ve)){
  S11RE_err[i] <- df_ve$`S11 Real`[i] - S11_avg$S11RE_avg[which(S11_avg$`Freq_GHz` == df_ve$`Freq_GHz`[i])]
  S11IM_err[i] <- df_ve$`S11 Img`[i] - S11_avg$S11IM_avg[which(S11_avg$`Freq_GHz` == df_ve$`Freq_GHz`[i])]
}

# Bind the data to the origional df
df_ve <- cbind(df_ve, S11RE_err, S11IM_err)

# Calculate the vector error
df_ve <- df_ve %>% mutate(`Vector Error` = sqrt(df_ve$S11RE_err^2 + df_ve$S11IM_err^2))


# Create the plot title
#title <- paste(company, " ", cable_name, ": Vector at Each Frequency Over ", total_cycles / cycs_between_meas, " measurements", sep = "")
title <- paste(company, " ", ": Vector at Each Frequency Over ", total_cycles / cycs_between_meas, " measurements", sep = "")

p <- ggplot(data = df_ve, mapping = aes(x = `Freq_GHz`, y = `Vector Error`, group = Cycle, color = Cycle)) +
  geom_line() +
  xlab("Frequency (GHz)") +
  ylab("Vector Error of S11") +
  ggtitle(title) +
  scale_color_gradientn(colors = rainbow(10)) #+ 
  #theme(plot.title = element_text(size = 18, face = "bold"), axis.title = element_text(size = 18), axis.text = element_text(size = 14), 
        #legend.text = element_text(size=14), legend.title=element_text(size=14))


p <- p + geom_line(aes(x = df_ve$`Freq_GHz`, y = df_ve$S11_Vect_Err_spec))

ggplotly(p)

#################################
```



```{r Plotting Delta, echo = FALSE, warning = FALSE, eval = FALSE}

#### Plot Delta From First Measurement

This plot is used to visualize the S21 data taken over the course of the `r total_cycles` mating cycles on the `r company` `r cable_name`. The color of each trace corresponds to which mating cycle the data sample was taken on with red indicating earlier measurements and purple indicating later measurements.

# Plot all S21 from all measurements

# Create variable that is delta from the first S11 and S21 measurement

# Get the data from measurment 1
baseline <- df[which(df$meas == 1),]

# Calculate the S11 Delta
delta_S11 <- c(0)
for(i in 1:nrow(df)){
  delta_S11[i] <- df$`S11 dB`[i] - baseline$`S11 dB`[which(baseline$`Freq_GHz` == df$`Freq_GHz`[i])]
}


# Claculate the S21 Delta
delta_S21 <- c(0)
for(i in 1:nrow(df)){
  delta_S21[i] <- df$`S21 dB`[i] - baseline$`S21 dB`[which(baseline$`Freq_GHz` == df$`Freq_GHz`[i])]
}

df <- cbind(df, delta_S11, delta_S21)

df_melt_S21 <- melt(df, id.vars = c("Freq_GHz","Cycle"), measure.vars = c("delta_S21"))

title <- paste(company, " ", ": Delta S21 Data over ", total_cycles, " cycles", sep = "")  

p <- ggplot(data = df_melt_S21, mapping = aes(x = `Freq_GHz`, y = value, group = Cycle, color = Cycle)) + 
  geom_line(size = 0.5) +
  geom_line() +
  #xlim(0,43.5) +
  labs(x = "Frequency (GHz)", y = "Magnitude of S21 (dB)", col = "Cycle") + 
  ggtitle(title) +
  scale_color_gradientn(colors = rainbow(10)) #+ 
  #theme(plot.title = element_text(size = 18, face = "bold"), axis.title = element_text(size = 18), axis.text = element_text(size = 14), 
        #legend.text = element_text(size=14), legend.title=element_text(size=14))

ggplotly(p)






df_melt_S11 <- melt(df, id.vars = c("Freq_GHz","Cycle"), measure.vars = c("delta_S11"))

title <- paste(company, " ", ": Delta S11 Data over ", total_cycles, " cycles", sep = "")  

p <- ggplot(data = df_melt_S11, mapping = aes(x = `Freq_GHz`, y = value, group = Cycle, color = Cycle)) + 
  geom_line(size = 0.5) +
  geom_line() +
  #xlim(0,43.5) +
  labs(x = "Frequency (GHz)", y = "Magnitude of S11 (dB)", col = "Cycle") + 
  ggtitle(title) +
  scale_color_gradientn(colors = rainbow(5)) #+ 
  #theme(plot.title = element_text(size = 18, face = "bold"), axis.title = element_text(size = 18), axis.text = element_text(size = 14), 
        #legend.text = element_text(size=14), legend.title=element_text(size=14))

ggplotly(p)

```










